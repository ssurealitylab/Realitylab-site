<script>
document.addEventListener('DOMContentLoaded', function() {
  // SIDL Image Data - Updated with correct filenames
  const sidlImageData = {
    dust: [
      'Case073_D.png', 'Case101_D.png', 'Case107_D.png', 'Case151_D.png', 
      'Case159_D.png', 'Case193_D.png', 'Case196_D.png'
    ],
    finger: [
      'Case051_F.png', 'Case073_F.png', 'Case107_F.png', 'Case151_F.png',
      'Case159_F.png', 'Case193_F.png', 'Case196_F.png', 'Case212_F.png',
      'Case217_F.png', 'Case218_F.png', 'Case247_F.png'
    ],
    mixed: [
      'Case151_DW.png'
    ],
    scratch: [
      'Case073_S.png', 'Case074_S.png', 'Case101_S.png', 'Case102_S.png',
      'Case107_S.png', 'Case193_S.png', 'Case196_S.png'
    ],
    water: [
      'Case051_W.png', 'Case073_W.png', 'Case102_W.png', 'Case107_W.png',
      'Case151_W.png', 'Case193_W.png', 'Case196_W.png', 'Case213_W.png'
    ]
  };
  
  // Debug: Log image data on load
  console.log('SIDL Image Data loaded:', sidlImageData);

  let currentContaminant = 'dust';
  let currentImageIndex = 0;
  let autoRotateTimer;
  let isDragging = false;
  
  const inputImage = document.getElementById('sidlInputImage');
  const targetImage = document.getElementById('sidlTargetImage');
  const inputContainer = document.getElementById('sidlInputContainer');
  const divider = document.getElementById('sidlDivider');
  const handle = document.getElementById('sidlHandle');
  const wrapper = document.querySelector('.sidl-image-wrapper');

  // Update images based on current selection
  function updateImages() {
    const images = sidlImageData[currentContaminant];
    if (images && images.length > 0) {
      const imageName = images[currentImageIndex];
      const basePath = `{{ site.baseurl }}/assets/img/sidl/${currentContaminant}`;
      
      if (inputImage) inputImage.src = `${basePath}/input/${imageName}`;
      if (targetImage) targetImage.src = `${basePath}/target/${imageName}`;
    }
  }

  // Update slider position
  function updateSliderPosition(percentage) {
    if (inputContainer && divider && handle) {
      // Clamp percentage between 0 and 100
      percentage = Math.max(0, Math.min(100, percentage));
      
      // Update clip-path for input container (left side)
      inputContainer.style.clipPath = `inset(0 ${100-percentage}% 0 0)`;
      
      // Update divider and handle position
      divider.style.left = `${percentage}%`;
      handle.style.left = `${percentage}%`;
    }
  }

  // Handle mouse/touch events for dragging
  function handleStart(clientX) {
    isDragging = true;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  }

  function handleMove(clientX) {
    if (!isDragging || !wrapper) return;
    
    const rect = wrapper.getBoundingClientRect();
    const x = clientX - rect.left;
    const percentage = (x / rect.width) * 100;
    
    updateSliderPosition(percentage);
  }

  function handleEnd() {
    isDragging = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  }

  // Mouse events
  if (wrapper && handle && divider) {
    // Mouse events
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      handleStart(e.clientX);
    });

    wrapper.addEventListener('mousedown', function(e) {
      e.preventDefault();
      handleStart(e.clientX);
      handleMove(e.clientX);
    });

    document.addEventListener('mousemove', function(e) {
      if (isDragging) {
        e.preventDefault();
        handleMove(e.clientX);
      }
    });

    document.addEventListener('mouseup', handleEnd);

    // Touch events for mobile
    handle.addEventListener('touchstart', function(e) {
      e.preventDefault();
      handleStart(e.touches[0].clientX);
    });

    wrapper.addEventListener('touchstart', function(e) {
      e.preventDefault();
      handleStart(e.touches[0].clientX);
      handleMove(e.touches[0].clientX);
    });

    document.addEventListener('touchmove', function(e) {
      if (isDragging) {
        e.preventDefault();
        handleMove(e.touches[0].clientX);
      }
    });

    document.addEventListener('touchend', handleEnd);
  }

  // Start auto rotation
  function startAutoRotation() {
    clearInterval(autoRotateTimer);
    autoRotateTimer = setInterval(() => {
      const images = sidlImageData[currentContaminant];
      if (images && images.length > 0) {
        currentImageIndex = (currentImageIndex + 1) % images.length;
        updateImages();
      }
    }, 5000); // Change every 5 seconds
  }

  // Extract case number from filename (e.g., "Case151_D.png" -> "Case151")
  function getCaseNumberFromFilename(filename) {
    const match = filename.match(/^(Case\d+)_/);
    return match ? match[1] : null;
  }

  // Find image with same case number in new category
  function findSameCaseInCategory(currentFilename, newCategory) {
    const caseNumber = getCaseNumberFromFilename(currentFilename);
    if (!caseNumber || !sidlImageData[newCategory]) return 0;
    
    const newCategoryImages = sidlImageData[newCategory];
    
    // Special handling for mixed category - always start from index 0 to avoid confusion
    if (currentContaminant === 'mixed' || newCategory === 'mixed') {
      console.log(`Mixed category transition detected, using index 0`);
      return 0;
    }
    
    for (let i = 0; i < newCategoryImages.length; i++) {
      const newCaseNumber = getCaseNumberFromFilename(newCategoryImages[i]);
      if (newCaseNumber === caseNumber) {
        return i;
      }
    }
    return 0; // Fallback to first image if no match found
  }

  // Handle contamination type change
  function switchContaminationType(newType) {
    console.log('Switching contamination type from', currentContaminant, 'to', newType);
    
    // Special handling for mixed category - always reset to index 0
    if (newType === 'mixed' || currentContaminant === 'mixed') {
      console.log('Mixed category detected - resetting to index 0');
      currentImageIndex = 0;
    } else {
      // Try to find the same case number in the new category
      const currentImages = sidlImageData[currentContaminant];
      if (currentImages && currentImages[currentImageIndex]) {
        const currentFilename = currentImages[currentImageIndex];
        const newImageIndex = findSameCaseInCategory(currentFilename, newType);
        console.log(`Looking for same case as ${currentFilename} in ${newType} category, found index: ${newImageIndex}`);
        currentImageIndex = newImageIndex;
      } else {
        currentImageIndex = 0;
      }
    }
    
    currentContaminant = newType;
    updateImages();
    startAutoRotation();
    
    // Update button active states
    document.querySelectorAll('#contaminantTypes .btn').forEach(btn => {
      const input = btn.querySelector('input[name="contaminant"]');
      if (input && input.value === newType) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }

  // Unified event handler for contamination type buttons
  function setupContaminationTypeButtons() {
    document.querySelectorAll('#contaminantTypes .btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const input = this.querySelector('input[name="contaminant"]');
        if (input && input.value !== currentContaminant) {
          // Clear all selections first
          document.querySelectorAll('input[name="contaminant"]').forEach(r => r.checked = false);
          document.querySelectorAll('#contaminantTypes .btn').forEach(b => b.classList.remove('active'));
          
          // Set new selection
          input.checked = true;
          this.classList.add('active');
          
          // Switch contamination type
          switchContaminationType(input.value);
        }
      });
    });
  }

  // Initialize when modal opens
  const modal = document.getElementById('repo1');
  if (modal) {
    modal.addEventListener('shown.bs.modal', function() {
      updateImages();
      startAutoRotation();
      updateSliderPosition(50); // Start with 50/50 split
      setupContaminationTypeButtons(); // Setup button event handlers
    });

    // Clean up when modal closes
    modal.addEventListener('hidden.bs.modal', function() {
      clearInterval(autoRotateTimer);
      handleEnd(); // Stop any dragging
    });
  }

  // Initialize immediately if elements exist
  if (inputImage && targetImage) {
    updateImages();
    startAutoRotation();
    updateSliderPosition(50); // Start with 50/50 split
    setupContaminationTypeButtons(); // Setup button event handlers
  }
});
</script>