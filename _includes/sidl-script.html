<script>
document.addEventListener('DOMContentLoaded', function() {
  // SIDL Image Data - Fixed to use actual matching image names
  const sidlImageData = {
    dust: [
      'Case073_D.png', 'Case101_D.png', 'Case107_D.png', 'Case151_D.png', 
      'Case159_D.png', 'Case193_D.png', 'Case196_D.png'
    ],
    finger: [
      'Case051_F.png', 'Case073_F.png', 'Case107_F.png', 'Case151_F.png',
      'Case159_F.png', 'Case193_F.png', 'Case196_F.png', 'Case212_F.png',
      'Case217_F.png', 'Case218_F.png', 'Case247_F.png'
    ],
    mixed: [
      'Case151_DW.png', 'Case151_FD.png', 'Case151_FS.png', 'Case151_FW.png',
      'Case245_DS.png', 'Case245_DW.png', 'Case297_DW.png'
    ],
    scratch: [
      'Case073_S.png', 'Case074_S.png', 'Case101_S.png', 'Case102_S.png',
      'Case107_S.png', 'Case193_S.png', 'Case196_S.png'
    ],
    water: [
      'Case051_W.png', 'Case073_W.png', 'Case102_W.png', 'Case107_W.png',
      'Case151_W.png', 'Case193_W.png', 'Case196_W.png', 'Case213_W.png'
    ]
  };

  let currentContaminant = 'dust';
  let currentImageIndex = 0;
  let autoRotateTimer;
  let isDragging = false;
  
  const inputImage = document.getElementById('sidlInputImage');
  const targetImage = document.getElementById('sidlTargetImage');
  const inputContainer = document.getElementById('sidlInputContainer');
  const divider = document.getElementById('sidlDivider');
  const handle = document.getElementById('sidlHandle');
  const wrapper = document.querySelector('.sidl-image-wrapper');

  // Update images based on current selection
  function updateImages() {
    const images = sidlImageData[currentContaminant];
    if (images && images.length > 0) {
      const imageName = images[currentImageIndex];
      const basePath = `{{ site.baseurl }}/assets/img/sidl/${currentContaminant}`;
      
      if (inputImage) inputImage.src = `${basePath}/input/${imageName}`;
      if (targetImage) targetImage.src = `${basePath}/target/${imageName}`;
    }
  }

  // Update slider position
  function updateSliderPosition(percentage) {
    if (inputContainer && divider && handle) {
      // Clamp percentage between 0 and 100
      percentage = Math.max(0, Math.min(100, percentage));
      
      // Update clip-path for input container (left side)
      inputContainer.style.clipPath = `inset(0 ${100-percentage}% 0 0)`;
      
      // Update divider and handle position
      divider.style.left = `${percentage}%`;
      handle.style.left = `${percentage}%`;
    }
  }

  // Handle mouse/touch events for dragging
  function handleStart(clientX) {
    isDragging = true;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  }

  function handleMove(clientX) {
    if (!isDragging || !wrapper) return;
    
    const rect = wrapper.getBoundingClientRect();
    const x = clientX - rect.left;
    const percentage = (x / rect.width) * 100;
    
    updateSliderPosition(percentage);
  }

  function handleEnd() {
    isDragging = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  }

  // Mouse events
  if (wrapper && handle && divider) {
    // Mouse events
    handle.addEventListener('mousedown', function(e) {
      e.preventDefault();
      handleStart(e.clientX);
    });

    wrapper.addEventListener('mousedown', function(e) {
      e.preventDefault();
      handleStart(e.clientX);
      handleMove(e.clientX);
    });

    document.addEventListener('mousemove', function(e) {
      if (isDragging) {
        e.preventDefault();
        handleMove(e.clientX);
      }
    });

    document.addEventListener('mouseup', handleEnd);

    // Touch events for mobile
    handle.addEventListener('touchstart', function(e) {
      e.preventDefault();
      handleStart(e.touches[0].clientX);
    });

    wrapper.addEventListener('touchstart', function(e) {
      e.preventDefault();
      handleStart(e.touches[0].clientX);
      handleMove(e.touches[0].clientX);
    });

    document.addEventListener('touchmove', function(e) {
      if (isDragging) {
        e.preventDefault();
        handleMove(e.touches[0].clientX);
      }
    });

    document.addEventListener('touchend', handleEnd);
  }

  // Start auto rotation
  function startAutoRotation() {
    clearInterval(autoRotateTimer);
    autoRotateTimer = setInterval(() => {
      const images = sidlImageData[currentContaminant];
      if (images && images.length > 0) {
        currentImageIndex = (currentImageIndex + 1) % images.length;
        updateImages();
      }
    }, 5000); // Change every 5 seconds
  }

  // Handle contamination type change
  document.querySelectorAll('input[name="contaminant"]').forEach(input => {
    input.addEventListener('change', function() {
      if (this.checked) {
        console.log('Switching to contamination type:', this.value);
        currentContaminant = this.value;
        currentImageIndex = 0;
        updateImages();
        startAutoRotation();
      }
    });
  });

  // Also handle click events on labels for better responsiveness
  document.querySelectorAll('#contaminantTypes label').forEach(label => {
    label.addEventListener('click', function(e) {
      const input = this.querySelector('input[name="contaminant"]');
      if (input && !input.checked) {
        console.log('Label clicked, switching to:', input.value);
        currentContaminant = input.value;
        currentImageIndex = 0;
        updateImages();
        startAutoRotation();
      }
    });
  });

  // Initialize when modal opens
  const modal = document.getElementById('repo1');
  if (modal) {
    modal.addEventListener('shown.bs.modal', function() {
      updateImages();
      startAutoRotation();
      updateSliderPosition(50); // Start with 50/50 split
    });

    // Clean up when modal closes
    modal.addEventListener('hidden.bs.modal', function() {
      clearInterval(autoRotateTimer);
      handleEnd(); // Stop any dragging
    });
  }

  // Initialize immediately if elements exist
  if (inputImage && targetImage) {
    updateImages();
    startAutoRotation();
    updateSliderPosition(50); // Start with 50/50 split
  }
});
</script>